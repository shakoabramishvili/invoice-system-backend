name: Deploy Backend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Pull and Deploy Backend
        run: |
          cd /var/www/invoice-system-backend

          echo "Discarding local changes to lock files..."
          git checkout -- package-lock.json yarn.lock 2>/dev/null || true

          echo "Pulling latest code from main..."
          git pull origin main

          echo "Cleaning build cache..."
          rm -rf dist/
          rm -rf node_modules/
          rm -rf .tsbuildinfo
          rm -rf node_modules/.cache/
          rm -rf ~/.npm/_cacache/

          echo "Installing dependencies..."
          npm install

          echo "Pulling DB schema..."
          npx prisma db pull

          echo "Generating Prisma client..."
          npx prisma generate

          echo "Building app with adequate memory..."
          NODE_OPTIONS="--max-old-space-size=2048" npm run build

          echo "Ensuring logs directory exists..."
          mkdir -p logs

          echo "Stopping and deleting PM2 backend process..."
          sudo pm2 delete backend || true

          echo "Starting backend with PM2..."
          pm2 start ecosystem.config.js --update-env

          echo "Saving PM2 configuration..."
          pm2 save

          echo "Checking PM2 status..."
          pm2 status

          echo "Showing recent PM2 logs..."
          pm2 logs --lines 50 --nostream

          echo "Deployment completed successfully."
