name: Deploy Backend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Pull and Deploy Backend
        run: |
          cd /var/www/invoice-system-backend

          echo "Pulling latest code from main..."
          git pull origin main

          echo "Stopping PM2 backend..."
          sudo pm2 stop backend

          echo "Cleaning build directories..."
          sudo rm -rf dist
          sudo rm -rf dist.old
          rm -rf node_modules/.cache

          echo "Installing dependencies..."
          npm install

          echo "Pulling DB schema..."
          npx prisma db pull

          echo "Generating Prisma client..."
          npx prisma generate

          echo "Building application..."
          npm run build

          echo "Ensuring logs directory exists..."
          mkdir -p logs

          echo "Starting PM2..."
          sudo pm2 start ecosystem.config.js

          echo "Checking PM2 status..."
          sudo pm2 status

          echo "Deployment completed successfully."
