name: Deploy Backend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Pull and Deploy Backend
        run: |
          cd /var/www/invoice-system-backend

          echo "Pulling latest code from main..."
          git pull origin main

          echo "Installing dependencies..."
          npm install

          echo "Running Prisma migrations..."
          npx prisma generate

          # Try to deploy migrations, if it fails due to non-empty DB, baseline it
          if ! npx prisma migrate deploy 2>&1 | tee /tmp/migrate-output.log; then
            if grep -q "P3005" /tmp/migrate-output.log; then
              echo "Database needs to be baselined. Marking all migrations as applied..."
              for migration in prisma/migrations/*/; do
                migration_name=$(basename "$migration")
                echo "Marking migration as applied: $migration_name"
                npx prisma migrate resolve --applied "$migration_name" || true
              done
              echo "Attempting deployment again..."
              npx prisma migrate deploy
            else
              echo "Migration failed with a different error"
              exit 1
            fi
          fi

          echo "Building application..."
          npm run build

          echo "Ensuring logs directory exists..."
          mkdir -p logs

          echo "Restarting with PM2..."
          pm2 startOrReload ecosystem.config.js --update-env

          echo "Checking PM2 status..."
          pm2 status

          echo "Deployment completed successfully."
