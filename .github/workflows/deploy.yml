name: Deploy Backend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Pull and Deploy Backend
        run: |
          cd /var/www/invoice-system-backend

          echo "Pulling latest code from main..."
          git pull origin main

          echo "Installing dependencies..."
          npm install

          echo "Running Prisma migrations..."
          npx prisma generate
          npx prisma migrate deploy

          echo "Building application..."
          npm run build

          echo "Ensuring logs directory exists..."
          mkdir -p logs

          echo "Restarting with PM2..."
          pm2 startOrReload ecosystem.config.js --update-env

          echo "Checking PM2 status..."
          pm2 status

          echo "Deployment completed successfully."
