name: Deploy Backend

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Pull and Deploy Backend
        run: |
          cd /var/www/invoice-system-backend

          echo "Discarding local changes to lock files..."
          git checkout -- package-lock.json yarn.lock 2>/dev/null || true

          echo "Pulling latest code from main..."
          git pull origin main

          echo "Installing dependencies..."
          npm install

          echo "Running Prisma migrations..."
          npx prisma generate
          npx prisma migrate deploy || echo "Migration failed, but continuing..."

          echo "Building application..."
          npm run build

          echo "Ensuring logs directory exists..."
          mkdir -p logs

          echo "Restarting with PM2..."
          pm2 startOrReload ecosystem.config.js --update-env

          echo "Checking PM2 status..."
          pm2 status

          echo "Showing recent PM2 logs..."
          pm2 logs --lines 50 --nostream

          echo "Deployment completed successfully."
